<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>UDP-WG Implementation: wireguard::CookiePacket Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">UDP-WG Implementation
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespacewireguard.html">wireguard</a></li><li class="navelem"><a class="el" href="classwireguard_1_1CookiePacket.html">CookiePacket</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="classwireguard_1_1CookiePacket-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">wireguard::CookiePacket Class Reference</div></div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="wireguard_8h_source.html">wireguard.h</a>&gt;</code></p>
<div class="dynheader">
Inheritance diagram for wireguard::CookiePacket:</div>
<div class="dyncontent">
 <div class="center">
  <img src="classwireguard_1_1CookiePacket.png" usemap="#wireguard::CookiePacket_map" alt=""/>
  <map id="wireguard::CookiePacket_map" name="wireguard::CookiePacket_map">
<area href="classwireguard_1_1Packet.html" title="For both security and ease of use, we want to use crypto::string as much as possible...." alt="wireguard::Packet" shape="rect" coords="0,0,152,24"/>
  </map>
</div></div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a0e6bbcec449a3c35baf269c612be33ed" id="r_a0e6bbcec449a3c35baf269c612be33ed"><td class="memItemLeft" align="right" valign="top"><a id="a0e6bbcec449a3c35baf269c612be33ed" name="a0e6bbcec449a3c35baf269c612be33ed"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>CookiePacket</b> (const std::string &amp;buffer)</td></tr>
<tr class="separator:a0e6bbcec449a3c35baf269c612be33ed"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:abfc45d4de354552a4ae0334b5e030d45" id="r_abfc45d4de354552a4ae0334b5e030d45"><td class="memItemLeft" align="right" valign="top"><a id="abfc45d4de354552a4ae0334b5e030d45" name="abfc45d4de354552a4ae0334b5e030d45"></a>
<a class="el" href="classcrypto_1_1string.html">crypto::string</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator[]</b> (const size_t &amp;val)</td></tr>
<tr class="separator:abfc45d4de354552a4ae0334b5e030d45"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7e3f60254b899451eea94941fd65354" id="r_ab7e3f60254b899451eea94941fd65354"><td class="memItemLeft" align="right" valign="top"><a id="ab7e3f60254b899451eea94941fd65354" name="ab7e3f60254b899451eea94941fd65354"></a>
const <a class="el" href="classcrypto_1_1string.html">crypto::string</a> &amp;&#160;</td><td class="memItemRight" valign="bottom"><b>operator[]</b> (const size_t &amp;val) const</td></tr>
<tr class="separator:ab7e3f60254b899451eea94941fd65354"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="inherit_header pub_methods_classwireguard_1_1Packet"><td colspan="2" onclick="javascript:dynsection.toggleInherit('pub_methods_classwireguard_1_1Packet')"><img src="closed.png" alt="-"/>&#160;Public Member Functions inherited from <a class="el" href="classwireguard_1_1Packet.html">wireguard::Packet</a></td></tr>
<tr class="memitem:a83e05ab97556fce8c16d6ea0baae979f inherit pub_methods_classwireguard_1_1Packet" id="r_a83e05ab97556fce8c16d6ea0baae979f"><td class="memItemLeft" align="right" valign="top">std::string&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classwireguard_1_1Packet.html#a83e05ab97556fce8c16d6ea0baae979f">Serialize</a> ()</td></tr>
<tr class="memdesc:a83e05ab97556fce8c16d6ea0baae979f inherit pub_methods_classwireguard_1_1Packet"><td class="mdescLeft">&#160;</td><td class="mdescRight">Serialize the packet.  <br /></td></tr>
<tr class="separator:a83e05ab97556fce8c16d6ea0baae979f inherit pub_methods_classwireguard_1_1Packet"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a6cb4564cbc8ee97dcab5edfdc69ebcdc inherit pub_methods_classwireguard_1_1Packet" id="r_a6cb4564cbc8ee97dcab5edfdc69ebcdc"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="classwireguard_1_1Packet.html#a6cb4564cbc8ee97dcab5edfdc69ebcdc">Expand</a> (const std::string &amp;buffer, const bool &amp;fill=false)</td></tr>
<tr class="memdesc:a6cb4564cbc8ee97dcab5edfdc69ebcdc inherit pub_methods_classwireguard_1_1Packet"><td class="mdescLeft">&#160;</td><td class="mdescRight">Construct a <a class="el" href="classwireguard_1_1Packet.html" title="For both security and ease of use, we want to use crypto::string as much as possible....">Packet</a> from a std::string.  <br /></td></tr>
<tr class="separator:a6cb4564cbc8ee97dcab5edfdc69ebcdc inherit pub_methods_classwireguard_1_1Packet"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-static-attribs" name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr class="memitem:a271abc270e1c124b34638baadf673153" id="r_a271abc270e1c124b34638baadf673153"><td class="memItemLeft" align="right" valign="top"><a id="a271abc270e1c124b34638baadf673153" name="a271abc270e1c124b34638baadf673153"></a>
static constexpr size_t&#160;</td><td class="memItemRight" valign="bottom"><b>reserved</b> = 0</td></tr>
<tr class="separator:a271abc270e1c124b34638baadf673153"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aab90f46d876ed31aab7a914a62d7ba02" id="r_aab90f46d876ed31aab7a914a62d7ba02"><td class="memItemLeft" align="right" valign="top"><a id="aab90f46d876ed31aab7a914a62d7ba02" name="aab90f46d876ed31aab7a914a62d7ba02"></a>
static constexpr size_t&#160;</td><td class="memItemRight" valign="bottom"><b>receiver</b> = 1</td></tr>
<tr class="separator:aab90f46d876ed31aab7a914a62d7ba02"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4e0b5bdf8166ee25d83c1d89c727d172" id="r_a4e0b5bdf8166ee25d83c1d89c727d172"><td class="memItemLeft" align="right" valign="top"><a id="a4e0b5bdf8166ee25d83c1d89c727d172" name="a4e0b5bdf8166ee25d83c1d89c727d172"></a>
static constexpr size_t&#160;</td><td class="memItemRight" valign="bottom"><b>nonce</b> = 2</td></tr>
<tr class="separator:a4e0b5bdf8166ee25d83c1d89c727d172"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aa02905cc4840494de23d73175a387713" id="r_aa02905cc4840494de23d73175a387713"><td class="memItemLeft" align="right" valign="top"><a id="aa02905cc4840494de23d73175a387713" name="aa02905cc4840494de23d73175a387713"></a>
static constexpr size_t&#160;</td><td class="memItemRight" valign="bottom"><b>cookie</b> = 3</td></tr>
<tr class="separator:aa02905cc4840494de23d73175a387713"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="inherited" name="inherited"></a>
Additional Inherited Members</h2></td></tr>
<tr class="inherit_header pro_attribs_classwireguard_1_1Packet"><td colspan="2" onclick="javascript:dynsection.toggleInherit('pro_attribs_classwireguard_1_1Packet')"><img src="closed.png" alt="-"/>&#160;Protected Attributes inherited from <a class="el" href="classwireguard_1_1Packet.html">wireguard::Packet</a></td></tr>
<tr class="memitem:af50faffb9beb90edbefa611ab82d5e3d inherit pro_attribs_classwireguard_1_1Packet" id="r_af50faffb9beb90edbefa611ab82d5e3d"><td class="memItemLeft" align="right" valign="top">
std::vector&lt; <a class="el" href="classcrypto_1_1string.html">crypto::string</a> &gt;&#160;</td><td class="memItemRight" valign="bottom"><b>values</b></td></tr>
<tr class="separator:af50faffb9beb90edbefa611ab82d5e3d inherit pro_attribs_classwireguard_1_1Packet"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><dl class="section remark"><dt>Remarks</dt><dd>The WireGuard Reference at 5.4.7 explains the idea of Cookie, where if the Server is overloaded and cannot accept new connections, it will return a cookie packet as opposed to the second packet of the handshake. The idea is that the peer will wait the timeout period, and when they request a handshake again, provide this cookie. Don't think of this cookie like an internet cookie: It doesn't cache any part of the handshake such that the peer can just sent the cookie as opposed to the first packet of the handshake. They still need to do the work, including generating new ephemeral keys; to my understanding, the cookie is little more than a priority queue. The Reference stipulates that (5.3): "When
the responder receives the message, if it is under load, it may choose whether or not to accept and process the
message based on whether or not there is a correct MAC that uses the cookie as the key. This mechanism ties
messages sent from an initiator to its IP address, giving proof of IP ownership, allowing for rate limiting using
classical IP rate limiting algorithms (token bucket, etcâ€”see section 7.4 for implementation details)" You may notice the language "choose to accept based on a correct MAC based on the cookie." (mac2). This, to me, reads that peers connecting without cookies are deprioritized to those that do have cookies. </dd>
<dd>
Now, onto how the Cookie actually works: The random value cookie_random is hashed with the clients IP and Port. This creates a random value, cycled every 2 minutes, that the server sends to clients. By setting the value with the client's IP, it necessarily ties the cookie to a particular client, so it can't be reused by other peers. However, if we send the cookie across the wire it would be possible to brute force the random value given that we know the IP of the peer; so, we add additional measures. Firstly, we encrypt the message with the server's public key (Nothing too special here), and use a randomized nonce (So a cookie cannot be reused), but then provide AAD as the mac1 of the the original packet. In doing so, only the person who sent the original handshake packet is able to decrypt the cookie. </dd></dl>
</div><hr/>The documentation for this class was generated from the following file:<ul>
<li>src/<a class="el" href="wireguard_8h_source.html">wireguard.h</a></li>
</ul>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
